<!DOCTYPE html>
<html>
    <head>
	<link rel="stylesheet" href="css/styles.css">
	<script src="js/env.js"></script>
	<script lang="javascript" src="js/jquery-3.1.0.min.js"></script>
	<script lang="javascript" src="js/d3.v4.min.js"></script>
	<script lang="javascript" src="js/data.js"></script>
	<script type="text/application/javascript/json" src="js/jquery.ajax-cross-origin.min.js"></script>

	<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    </head>
    <body>
      <svg width=100% height=100%></svg>
      <script>
	var width = $(window).width();
	var height = $(window).height();
	var svg = d3.select("svg")
	.attr('width','100%')
	.attr('height','100%');
	
	var bar_container = svg.append('g')
	.attr('width',.75*width)
	.attr('height',.75*height);
	
	bar_container.append('rect')
	.attr('fill','#e6e6fa')
	.attr('width',bar_container.attr('width'))
	.attr('height',bar_container.attr('height'));
	
	var plot_container = svg.append('g')
				.attr('width',.75*width)
				.attr('height',.25*height)
				.attr('transform','translate(0,' + .75*height + ')')
       plot_container.append('rect')
				.attr('width',plot_container.attr('width'))
				.attr('height',plot_container.attr('height')) 	 
				.attr('fill','#fffaf0');
	
	var entity_container = svg.append('g')
	.attr('width',.25*width)
	.attr('height',height)
	.attr('transform','translate(' + .75*width + ',0)')
	entity_container.append('rect')
	.attr('width',entity_container.attr('width'))
	.attr('height',entity_container.attr('height')) 	 
	.attr('fill','#e0eee0');


	var graph = plot_container.append('div')
	.attr('id','graph')
	.attr('width',width*.25)
	.attr('height',height*.1);
	
 

       var short_labels = ['ABC','BBC','BBN','BI','BZFD','CBC','CBS','CNBC','CNN','FT','FOX','MSNBC','NBC','POL','ECON','HUFF','NYT','WSJ','WASH','USA'];

       var entities=['Donald Trump','Khashoggi',"U.S.",'Facebook','Amazon'];
       var entity = entities[0];
       var entity_images=['donald_trump.jpg','jamal_khashoggi.jpg','saudi.svg','usa.png','democrat_logo.png','republican_logo.svg','facebook.png','amazon.png'];
       var data;
       var green = "#11cc00";
       //establish top entities
       var top_entities = entity_container.selectAll(".entity-image")
					  .data(entity_images)
					  .enter().append("g")
					  .attr("class","entity-image");
       //inside each top entity object, append an image
       top_entities.append("image")
		   .attr("id",function(d) { return d; })
		   .attr("xlink:href", function(d) { return  "images/"+d; })
		   .attr("width",width*.1)
		   .attr("height","75px")
       //  .attr("x",function(d,i) { return width * .75; })//width*.11*i+15; })
		   .attr("y",function(d,i) { return height*.15*i + 150; })
		   .on("mouseover", function(d) {
		       d3.select(this).style("cursor","pointer");
		   })
		   .on("click", function(d,i) {
      		       var name = entities[i]
      		       d3.selectAll('text').style('visibility','visible');
      		       console.log(data);
		       var axis = d3.selectAll(".axis")
      		       d3.selectAll(".pos")
      				    .data(data[name].total_info)
      				    .transition().attr("height", positive_height)
      				    .attr("y", function(d) {
      					return height * .4 - 30 - positive_height(d);
      				    });
      		       d3.selectAll(".neg")
      			 .data(data[name].total_info)
      			 .transition().attr("height", negative_height);
      		       d3.selectAll(".neu")
      			 .data(data[name].total_info)
      			 .transition().attr("height", neutral_height)
      			 .attr("y", function(d) {
      			     return height * .9 - 30 - neutral_height(d);
      			 });
		   });
	    //inside each top entity object, append the name
       top_entities.append("text")
		   .attr("x",function(d,i) { return 75; }) //width*.75+75; })
		   .attr("y",function(d,i) { return height*.15*i+150; })
		   .text(function(d,i) { return entities[i]; })
		   .style('fill',function(d,i) {
		       if (i==0) return 'green';
		       else return 'black';
		   })
		   .style('text-anchor','middle');
       
       d3.json('dataset_with_time.json',function(dataset){
	   data = dataset;
	   console.log(data);
	   var x_offset=25;
	   console.log(data);
	   bar_container.selectAll(".pos")
    	    .data(data["Donald Trump"].total_info)
    	    .enter()
    	    .append("rect")
    	    .attr("class", "pos")
    	    .attr("height", positive_height)
    	    .attr("width", 20)
    	    .attr("x", function(d, i) {
    		return x_offset + i * 50 -10;
    	    })
    	    .attr("y", function(d) {
    		return bar_container.attr('height') * .3 - 30 - positive_height(d);
    	    })
    	    .attr("fill", green);
	   bar_container.selectAll(".neg")
  	    .data(data["Donald Trump"].total_info)
  	    .enter()
  	    .append("rect")
  	    .attr("class", "neg")
  	    .attr("height", negative_height)
  	    .attr("width", 20)
  	    .attr("x", function(d, i) {
  	    return x_offset + i * 50 -10;
  	    })
  	    .attr("y", bar_container.attr('height') * .3 + 2)
  	    .attr("fill", "red");
	    bar_container.selectAll(".polarized-source-text")
  	    .data(data["Donald Trump"].total_info)
	    .attr('class','polarized-source-text')
  	    .enter()
  	    .append('text')
  	    .attr('x', function(d, i) {
  	    return x_offset + i * 50;
  	    })
	    
  	    .attr('y', bar_container.attr('height') * .3 - 5)
  	    .text(function(d,i) {
  	    return short_labels[i];//d.source.source_id;
  	    })
	    .style('fill',function(d,i) {
	    if (i==0) return 'green';
	    else return 'black';
	    })
  	    .style('fill','black')
  	    .style('text-anchor','middle')
	    .on('mouseover', function(d){
	    d3.select(this).style('cursor','pointer');
	    })
	    .on('click', function(d,i) {
	    graph_news_org(i);
	    color_polarized_text(i);		 
	    });
	    bar_container.selectAll("#neutral-source-text")
  	    .data(data["Donald Trump"].total_info)
  	    .enter()
  	    .append('text')
  	    .attr('x', function(d, i) {
  	    return x_offset + i * 50;
  	    })
  	    .attr('y', bar_container.attr('height') * .75)
  	    .text(function(d,i) {
  	    return short_labels[i];
  	    })
  	    .style('fill','black')
  	    .style('text-anchor','middle');
	    bar_container.selectAll(".neu")
  	    .data(data["Donald Trump"].total_info)
  	    .enter()
  	    .append("rect")
  	    .attr("class", "neu")
  	    .attr("height", neutral_height)
  	    .attr("width", 20)
  	    .attr("x", function(d, i) {
  	    return x_offset + i * 50 -10;
  	    })
  	    .attr("y", function(d) {
  	    return bar_container.attr('height') *.75 - 30 - neutral_height(d);
  	    })
  	    .attr("fill", 'blue');

	    graph_news_org(0);
	    });

	    
	    function color_polarized_text(y){
	    d3.selectAll(".polarized-source-text")
	    .data(data["Donald Trump"].total_info)
	    .transition().style('fill',function(d,i){		 
	    if (i==y) { console.log("same!"); return 'green'; }
	    else { console.log('different'); return 'black'; }
	    ;});	  
	    }	 

	    function graph_news_org(news_org_loc){

	    var y=[];
	    d3.json('dataset_with_time.json',function(dataset){
	    data=dataset	     
	    for (var day in data['Donald Trump'].date_info){     	      
	    y.push(data['Donald Trump'].date_info[day]['daily_info'][news_org_loc]); //0th index is abc news
	    }
	    
	    var y_avg=[];
	    
	    for (var day in y){
	    //get average sentiment for this day
	    y_avg.push((y[day]['negative'].count * y[day]['negative'].sentiment + y[day]['positive'].count * y[day]['positive'].sentiment) / (y[day]['negative'].count + y[day]['positive'].count + y[day]['neutral'].count));		    
	    }
	    
	    var x = [14,15,16,17,18,19,20,21,22]
	    
	    TESTER = document.getElementById('graph');
	    Plotly.purge(TESTER);
	    Plotly.plot( TESTER, [{
	    x: x,
	    y: y_avg,}], {title: short_labels[news_org_loc] + ' news over the week for Trump'})
	    
	    });
	    };
	    
	    
	    function positive_height(d) {
	    total_count = d.positive.count + d.neutral.count + (d.negative.count);
	    if (total_count == 0) {
	    return 0;
	    }
	    return normalized_sentiment(d.positive.sentiment) * (d.positive.count / total_count) * 200;
	    }
	    function neutral_height(d) {
	    total_count = d.positive.count + d.neutral.count + (d.negative.count);
	    if (total_count == 0) {
	    return 0;
	    }
	    return (0.37 * d.neutral.count / total_count) * 200;
	    }
	    function negative_height(d) {
	    total_count = d.positive.count + d.neutral.count + (d.negative.count);
	    if (total_count == 0) {
	    return 0;
	    }
	    return normalized_sentiment(d.negative.sentiment) * (d.negative.count / total_count) * 200;
	    }
	    function normalized_sentiment(sentiment) {
	       var max_sent = 9.72;
	       var min_sent = -17.44;
	       return (sentiment - min_sent) / (max_sent - min_sent);
	    }
	    function normalized_sentiment_neutral(sentiment) {
	       var mean_sent = 0.037;
	     var std_sent = 0.328;
	       return (sentiment - mean_sent) / std_sent;
	    } 
	  
	</script>
    </body>
</html>


<!-- 	  //credit http://samherbert.net/svg-loaders/ for the startup image -->
<!-- 	  /* -->
<!-- 	   var im = g.append('svg:image') -->
<!-- 	   .attr('xlink:href','js/svg_loading/svg-loaders/circles.svg') -->
<!-- 	   .attr('x','50%') -->
<!-- 	   .attr('y','50%') -->
<!-- 	   .attr('width',200) -->
<!-- 	   .attr('height',200); -->
<!-- 	  */ -->

<!--      //var url = 'https://www.cs.tufts.edu/~mrussell/vis/test_dataset.json' -->

<!--      /* -->
<!--       * function call_ajax(query){ -->
<!-- 	$.ajax({ -->
<!-- 	crossOrigin: true, -->
<!-- 	url: env.ngrok_ip + '/get_saved', -->
<!-- 	type: "POST", -->
<!-- 	data: 'name='+query, -->
<!-- 	success: organize_data() -->
<!-- 	break; -->

<!--       * };  */ -->
<!-- daterangepicker from : http://www.daterangepicker.com/
     <!--  <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
     <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
     <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />


     <input type="text" name="daterange" value="01/01/2018 - 01/15/2018" />

     <script>
     $(function() {
     $('input[name="daterange"]').daterangepicker({
     opens: 'left'
     }, function(start, end, label) {
     console.log("A new date selection was made: " + start.format('YYYY-MM-DD') + ' to ' + end.format('YYYY-MM-DD'));
     });
     });
     </script>



-->

