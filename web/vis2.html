<!DOCTYPE html>
<html>
    <head>
	<link rel="stylesheet" href="css/styles.css">
	<script src="js/env.js"></script>
	<script lang="javascript" src="js/jquery-3.1.0.min.js"></script>
	<script lang="javascript" src="js/d3.v4.min.js"></script>
	<script lang="javascript" src="js/data.js"></script>
	<script type="text/application/javascript/json" src="js/jquery.ajax-cross-origin.min.js"></script>

	<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    </head>
    <body>
      <svg width=100% height=100%></svg>
      <script>

       var search_container = d3.select("body").append("div")
				.style('position','absolute')
				.style('top', '2%')
				.style('left', '76%')
				.style('transform','translate(' + .75*width + ',0)')

       search_container.append("input")
				.attr("type", "text")
				.attr("placeholder", "Search...")
				.attr("float", "right")
				.attr("padding", "6px")
				.attr("border", "none")
				.attr("margin-top", "8px")
				.attr("margin-right", "16px")
				.attr("font-size", "17px")
				.attr("size", 30)
				.attr("onkeydown", "search(this)");

       function search(ele) {
           if(event.key === 'Enter') {
               alert(ele.value);
           }
       }

       var width = $(window).width();
       var height = $(window).height();
       var svg = d3.select("svg")
		   .attr('width','100%')
		   .attr('height','100%');

       var bar_container = svg.append('g')
			      .attr('width',.75*width)

			      .attr('height',.65*height);

       bar_container.append('rect')
		    .attr('fill','#e6e6fa')
		    .attr('width',bar_container.attr('width'))
		    .attr('height',bar_container.attr('height'));

       var entity_container = svg.append('g')
				 .attr('width',.25*width)
				 .attr('height',height)
				 .attr('transform','translate(' + .75*width + ',0)')
       entity_container.append('rect')
				 .attr('width',entity_container.attr('width'))
				 .attr('height',entity_container.attr('height'))
				 .attr('fill','#e0eee0');


       var plot_container = d3.select('body').append('div')
			      .attr('id','plot_container')
			      .style('transform','translate(0,' + .65*height + ')')
			      .style('width',.75*width)
			      .style('height','35%')//.35*height)
			      .style('position','absolute')
			      .style('top',function() { return '65%'; })
			      .style('left',function() { return '15%'; });


       var short_labels = ['ABC','BBC','BBN','BI','BZFD','CBC','CBS','CNBC','CNN','FT','FOX','MSNBC','NBC','POL','ECON','HUFF','NYT','WSJ','WASH','USA'];

       var entities=['Donald Trump','Khashoggi',"U.S.",'Google', 'China', 'California', 'Congress'];
       var entity = entities[0];
       var entity_images=['donald_trump2.jpg','jamal_khashoggi.jpg','us.png','google.png', 'china.png', 'cal.png'];
       var data;
       var green = "#11cc00";

       var curr_news_source = 0;
       var curr_entity = 'Donald Trump';

       //establish top entities

       var top_entities = entity_container.selectAll(".entity-image")
					  .data(entity_images)
					  .enter().append("g")
					  .attr("class","entity-image");
       //inside each top entity object, append an image
       top_entities.append("image")
		   .attr("id",function(d) { return d; })
		   .attr("xlink:href", function(d) { return  "images/"+d; })
		   .attr("width",width*.1)
		   .attr("height","75px")
		   .attr("y",function(d,i) { return height*.14*i + 60; })
		   .on("mouseover", function(d) {
		       d3.select(this).style("cursor","pointer");
		   })
		   .on("click", function(d,i) {
		       var name = entities[i]
		       update_sentiment(name);
		   });

       function update_sentiment(name) {
           d3.selectAll('text').style('visibility','visible');
           console.log(data);
           var axis = d3.selectAll(".axis")
           d3.selectAll(".pos")
			.data(data[name].total_info)
			.transition().attr("height", positive_height)
			.attr("y", function(d) {
			    return bar_container.attr('height') * .3 - 30 - positive_height(d);
			});
           d3.selectAll(".neg")
             .data(data[name].total_info)
             .transition().attr("height", negative_height);
           d3.selectAll(".neu")
             .data(data[name].total_info)
             .transition().attr("height", neutral_height)
             .attr("y", function(d) {
		 return bar_container.attr('height') * .75 - 30 - neutral_height(d);
             });
	   curr_entity=name
	   graph_news_org(curr_news_source,curr_entity);
       }

       //inside each top entity object, append the name
       top_entities.append("text")
		   .attr("x",function(d,i) { return 160; }) //width*.75+75; })
		   .attr("y",function(d,i) { return height*.14*i+100; })
		   .text(function(d,i) { return entities[i]; })
		   .style('fill',function(d,i) {
		       return 'black';
		   })
		   .style('text-anchor','middle');

       d3.json('dataset_with_time2.json',function(dataset){
	   data = dataset;
	   console.log(data);
	   var x_offset=75;
	   console.log(data);
	   bar_container.selectAll(".pos")
    			.data(data[curr_entity].total_info)
    			.enter()
    			.append("rect")
    			.attr("class", "pos")
    			.attr("height", positive_height)
    			.attr("width", 20)
    			.attr("x", function(d, i) {
    			    return x_offset + i * 50 -10;
    			})
    			.attr("y", function(d) {
    			    return bar_container.attr('height') * .3 - 30 - positive_height(d);
    			})
    			.attr("fill", green);
	   bar_container.selectAll(".neg")
  			.data(data[curr_entity].total_info)
  			.enter()
  			.append("rect")
  			.attr("class", "neg")
  			.attr("height", negative_height)
  			.attr("width", 20)
  			.attr("x", function(d, i) {
  			    return x_offset + i * 50 -10;
  			})
  			.attr("y", bar_container.attr('height') * .3 + 2)
  			.attr("fill", "red");

	   bar_container.selectAll(".polarized-source-text")
  			.data(data[curr_entity].total_info)
			.attr('class','polarized-source-text')
  			.enter()
  			.append('text')
  			.attr('x', function(d, i) {
  			    return x_offset + i * 50;
  			})

  			.attr('y', bar_container.attr('height') * .3 - 5)
  			.text(function(d,i) {
  			    return short_labels[i];//d.source.source_id;
  			})
			.style('fill',function(d,i) {
			    'black';
			})
  			.style('fill','black')
  			.style('text-anchor','middle')
			.on('mouseover', function(d){
			    d3.select(this).style('cursor','pointer');
			})
			.on('click', function(d,i) {
			    console.log(d);
			    curr_news_source=i;
			    graph_news_org(curr_news_source,curr_entity);
			    color_polarized_text(i);
			});


	   polarized_axis = bar_container.append('line')
					 .style('stroke','black')
					 .attr('width','2')
					 .attr('x1',x_offset-25)
					 .attr('x2',x_offset-25)
					 .attr('y1',bar_container.attr('height') * .3 -  5 - 200)
					 .attr('y2',bar_container.attr('height') *.3 - 5 + 200);

	   polarized_axis = bar_container.append('line')
					 .style('stroke','black')
					 .attr('width','2')
					 .attr('x1',x_offset-25)
					 .attr('x2',x_offset-25)
					 .attr('y1',bar_container.attr('height') * .3 -  5 - 200)
					 .attr('y2',bar_container.attr('height') *.3 - 5 + 200);

	   bar_container.selectAll("#neutral-source-text")
  			.data(data[curr_entity].total_info)
  			.enter()
  			.append('text')
  			.attr('x', function(d, i) {
  			    return x_offset + i * 50;
  			})
  			.attr('y', bar_container.attr('height') * .75)
  			.text(function(d,i) {
  			    return short_labels[i];
  			})
  			.style('fill','black')
  			.style('text-anchor','middle');
	   bar_container.selectAll(".neu")
  			.data(data[curr_entity].total_info)
  			.enter()
  			.append("rect")
  			.attr("class", "neu")
  			.attr("height", neutral_height)
  			.attr("width", 20)
  			.attr("x", function(d, i) {
  			    return x_offset + i * 50 -10;
  			})
  			.attr("y", function(d) {
  			    return bar_container.attr('height') *.75 - 30 - neutral_height(d);
  			})
  			.attr("fill", 'blue');

	   graph_news_org(curr_news_source,curr_entity);
       });


       function color_polarized_text(y){
	   d3.selectAll(".polarized-source-text")
	     .data(data[curr_entity].total_info)
	     .transition().style('fill',function(d,i){
		 if (i==y) { console.log("same!"); return 'green'; }
		 else { console.log('different'); return 'black'; }
		 ;});
       }

       function graph_news_org(news_org_loc,entity_name){
	   var y=[];
	   d3.json('dataset_with_time2.json',function(dataset){
	       data=dataset
	       console.log(entity_name);
	       for (var day in data[entity_name].date_info){
		   y.push(data[entity_name].date_info[day]['daily_info'][news_org_loc]); //0th index is abc news

	       }

	       var y_avg=[];

	       for (var day in y){
		   //get average sentiment for this day

		   var normalized_pos = normalized_sentiment(y[day]['positive'].sentiment);
		   var normalized_neg = normalized_sentiment(y[day]['negative'].sentiment);
		   console.log(normalized_pos);
		   console.log(normalized_neg);
		   y_avg.push((y[day]['negative'].count * normalized_neg + y[day]['positive'].count * normalized_pos) / (y[day]['negative'].count + y[day]['positive'].count + y[day]['neutral'].count));
	       }

	       var x = [14,15,16,17,18,19,20,21,22]

	       TESTER = document.getElementById('plot_container');
	       console.log(TESTER);
	       Plotly.purge(TESTER);
	       Plotly.plot( TESTER, [{
		   x: x,
		   y: y_avg,}], {title: short_labels[news_org_loc] + ' news over the week for ' + entity_name});

	       //{ margin: { t: 0, l:0, r:0 },

	   });
       };


       function positive_height(d) {
	   total_count = d.positive.count + d.neutral.count + (d.negative.count);
	   if (total_count == 0) {
	       return 0;
	   }
	   return normalized_sentiment(d.positive.sentiment) * (d.positive.count / total_count) * 50;
       }
       function neutral_height(d) {
	   total_count = d.positive.count + d.neutral.count + (d.negative.count);
	   if (total_count == 0) {
	       return 0;
	   }
	   return (0.37 * d.neutral.count / total_count) * 50;
       }
       function negative_height(d) {
	   total_count = d.positive.count + d.neutral.count + (d.negative.count);
	   if (total_count == 0) {
	       return 0;
	   }
	   return normalized_sentiment(d.negative.sentiment) * -1 * (d.negative.count / total_count) * 50;
       }
       function normalized_sentiment(sentiment) {
	   var max_sent = 9.72;
	   var min_sent = -17.44;
	   var avg_sent = -0.0335;
	   var std_sent = 0.227;
	   //mean normalization
	   return ( sentiment - avg_sent ) / std_sent;
	   //  return (sentiment - avg_sent) / (max_sent - min_sent);
	   //return (sentiment - min_sent) / (max_sent - min_sent);// this is for min-max scaling
       }
       function normalized_sentiment_neutral(sentiment) {
	   var max_sent = 40.3;
	   var min_sent = 0;
	   var avg_sent = 0.037;
	   //	   return (sentiment - avg_sent) / (max_sent - min_sent);
	   //	   var std_sent = 0.328;
	   return (sentiment - avg_sent) / std_sent;
       }

       function search(ele) {
           if(event.key === 'Enter') {
               keys = Object.keys(data);
               console.log(keys);
               for (i = 0; i < keys.length; i++) {

		   if (keys[i].toLowerCase().includes(ele.value.toLowerCase())) {
                       update_sentiment(keys[i]);
                       break;
		   }
               }
           }
       }

      </script>
    </body>
</html>
